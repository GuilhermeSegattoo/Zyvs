// =====================================================
// ZYVA - Schema do Banco de Dados (PostgreSQL + Prisma)
// =====================================================
//
// Vers√£o: 1.0.0
// √öltima atualiza√ß√£o: 2025-01-11
//
// Principais mudan√ßas do schema Supabase:
// - Sistema de ROLES (ADMIN vs LOJA)
// - Multi-tenancy com Organizations
// - Simplifica√ß√£o de 19 ‚Üí 12 tabelas
// - Otimizado para Prisma
// - Adicionadas: Campanhas, Anivers√°rios, Posts Sociais
// - Removidas: Transactions, Coupons (features futuras)
// =====================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// AUTENTICA√á√ÉO E USU√ÅRIOS
// =====================================================

enum UserRole {
  ADMIN  // Acesso total ao sistema (gerencia todas as orgs)
  LOJA   // Usu√°rio cliente (pertence a uma organiza√ß√£o)
}

enum Plan {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Hash bcrypt
  name          String
  avatar        String?

  // Role e permiss√µes
  role          UserRole  @default(LOJA)

  // Organiza√ß√£o (apenas para role LOJA)
  organizationId String?
  organization   Organization? @relation("OrganizationMembers", fields: [organizationId], references: [id], onDelete: Cascade)

  // Para usu√°rios LOJA - limites do plano
  plan          Plan?     @default(FREE)
  planExpiry    DateTime?

  // Limites atuais (reset mensal)
  messagesUsedThisMonth   Int @default(0)
  flowExecutionsThisMonth Int @default(0)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Onboarding
  onboardingCompleted Boolean @default(false)

  // Rela√ß√µes quando √© OWNER de uma org
  ownedOrganizations Organization[] @relation("OrganizationOwner")

  // Rela√ß√µes de auditoria
  auditLogs     AuditLog[]

  // Rela√ß√µes de cria√ß√£o
  createdFlows     Flow[]
  createdCampaigns Campaign[]

  @@index([email])
  @@index([role])
  @@index([organizationId])
  @@map("users")
}

// =====================================================
// ORGANIZA√á√ïES (MULTI-TENANCY)
// =====================================================

model Organization {
  id          String   @id @default(cuid())

  // Owner (criador da organiza√ß√£o)
  ownerId     String
  owner       User     @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Dados da organiza√ß√£o
  name        String
  slug        String   @unique  // URL-friendly
  logo        String?
  email       String?
  phone       String?
  website     String?

  // Segmento de neg√≥cio
  businessSegment String?
  description     String?  @db.Text

  // Endere√ßo (JSON)
  address     Json?

  // Status
  isActive    Boolean  @default(true)

  // Plano e limites (herdado do owner, mas pode ser customizado)
  plan            Plan    @default(FREE)
  maxContacts     Int     @default(100)
  maxFlows        Int     @default(3)
  maxMessagesPerMonth Int @default(500)

  // Uso atual (atualizado em tempo real)
  currentContacts Int     @default(0)
  currentFlows    Int     @default(0)
  messagesThisMonth Int   @default(0)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Rela√ß√µes
  members     User[]   @relation("OrganizationMembers")
  contacts    Contact[]
  tags        Tag[]
  kanbanColumns KanbanColumn[]
  flows       Flow[]
  campaigns   Campaign[]
  messages    Message[]
  integrations Integration[]
  birthdayAutomation BirthdayAutomation?

  @@index([ownerId])
  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

// =====================================================
// CONTATOS (CRM)
// =====================================================

enum ContactStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model Contact {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Dados pessoais
  name            String
  email           String?
  phone           String?
  avatar          String?

  // Data de nascimento (para automa√ß√£o de anivers√°rios)
  birthdate       DateTime?     @db.Date

  // Dados adicionais
  gender          String?
  cpf             String?
  address         Json?         // { street, city, state, zip, country }

  // Informa√ß√µes de neg√≥cio
  dealValue       Decimal?      @db.Decimal(10, 2)
  source          String?       // De onde veio (landing page, indica√ß√£o, etc)
  notes           String?       @db.Text

  // Status
  status          ContactStatus @default(ACTIVE)

  // Estat√≠sticas
  lastInteraction DateTime?
  interactionCount Int          @default(0)
  totalSpent      Decimal       @default(0) @db.Decimal(10, 2)
  ordersCount     Int           @default(0)

  // Kanban (Pipeline)
  kanbanColumnId  String?
  kanbanColumn    KanbanColumn? @relation(fields: [kanbanColumnId], references: [id], onDelete: SetNull)

  // Campos customizados (JSON flex√≠vel)
  customFields    Json?

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Rela√ß√µes
  tags            Tag[]
  messages        Message[]
  flowExecutions  FlowExecution[]

  @@index([organizationId, createdAt])
  @@index([organizationId, email])
  @@index([organizationId, phone])
  @@index([birthdate])  // Para query de aniversariantes
  @@index([kanbanColumnId])
  @@map("contacts")
}

// =====================================================
// TAGS (Segmenta√ß√£o)
// =====================================================

model Tag {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name            String
  color           String       @default("#8b5cf6")  // Roxo padr√£o
  description     String?

  isActive        Boolean      @default(true)

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Rela√ß√µes
  contacts        Contact[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("tags")
}

// =====================================================
// KANBAN (PIPELINE DE VENDAS)
// =====================================================

model KanbanColumn {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name            String
  color           String       @default("#3b82f6")  // Azul padr√£o
  order           Int          // Ordem de exibi√ß√£o (0, 1, 2...)

  isDefault       Boolean      @default(false)  // Coluna padr√£o para novos contatos
  isFinal         Boolean      @default(false)  // Coluna final (ganhou/perdeu)
  isActive        Boolean      @default(true)

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Rela√ß√µes
  contacts        Contact[]

  @@unique([organizationId, order])
  @@index([organizationId])
  @@map("kanban_columns")
}

// =====================================================
// FLOW BUILDER (AUTOMA√á√ïES)
// =====================================================

enum FlowStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

model Flow {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  category        String?      // Ex: "P√≥s-venda", "Capta√ß√£o", "Reten√ß√£o"

  // Configura√ß√£o do flow (JSON)
  nodes           Json         @default("[]")  // Array de n√≥s
  edges           Json         @default("[]")  // Conex√µes entre n√≥s

  // Status
  status          FlowStatus   @default(DRAFT)

  // Estat√≠sticas
  lastExecution   DateTime?
  executionCount  Int          @default(0)
  successCount    Int          @default(0)
  errorCount      Int          @default(0)

  // Template
  isTemplate      Boolean      @default(false)

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdBy       String?
  createdByUser   User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  // Rela√ß√µes
  executions      FlowExecution[]

  @@index([organizationId, status])
  @@map("flows")
}

enum FlowExecutionStatus {
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

model FlowExecution {
  id              String              @id @default(cuid())
  flowId          String
  flow            Flow                @relation(fields: [flowId], references: [id], onDelete: Cascade)

  contactId       String
  contact         Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Estado da execu√ß√£o
  currentNodeId   String?             // ID do n√≥ atual no flow
  status          FlowExecutionStatus @default(RUNNING)

  // Logs e tracking
  executionLog    Json                @default("[]")  // Array de steps executados
  errorMessage    String?             @db.Text

  // M√©tricas
  nodesExecuted   Int                 @default(0)

  // Timestamps
  startedAt       DateTime            @default(now())
  completedAt     DateTime?

  @@index([flowId, status])
  @@index([contactId])
  @@map("flow_executions")
}

// =====================================================
// CAMPANHAS (MENSAGENS E POSTS SOCIAIS)
// =====================================================

enum CampaignType {
  MESSAGE      // Mensagem para contatos (WhatsApp/Email/SMS)
  SOCIAL_POST  // Post em rede social (Instagram/Facebook)
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
  INSTAGRAM_DM
}

enum SocialPlatform {
  INSTAGRAM
  FACEBOOK
  TWITTER
  LINKEDIN
}

model Campaign {
  id              String         @id @default(cuid())
  organizationId  String
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Configura√ß√£o
  name            String
  type            CampaignType

  // Para MESSAGE
  channel         MessageChannel?

  // Para SOCIAL_POST
  platform        SocialPlatform?

  // Conte√∫do
  content         String         @db.Text
  mediaUrl        String?        // URL da imagem/v√≠deo

  // Segmenta√ß√£o (para MESSAGE)
  targetAll       Boolean        @default(true)
  targetTagIds    String[]       // Array de IDs de tags

  // Agendamento
  status          CampaignStatus @default(DRAFT)
  scheduledFor    DateTime?

  // Vincula√ß√£o com Flow (opcional)
  linkedToFlow    Boolean        @default(false)
  flowId          String?

  // M√©tricas
  totalTargeted   Int            @default(0)  // Quantos contatos no alvo
  totalSent       Int            @default(0)  // Quantos enviados
  totalDelivered  Int            @default(0)  // Quantos entregues
  totalOpened     Int            @default(0)  // Quantos abertos
  totalClicked    Int            @default(0)  // Quantos clicaram
  totalFailed     Int            @default(0)  // Quantos falharam

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  sentAt          DateTime?
  createdBy       String?
  createdByUser   User?          @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  // Rela√ß√µes
  messages        Message[]

  @@index([organizationId, status])
  @@index([scheduledFor])
  @@map("campaigns")
}

// =====================================================
// MENSAGENS (HIST√ìRICO E AGENDAMENTO)
// =====================================================

enum MessageStatus {
  PENDING      // Aguardando envio
  QUEUED       // Na fila do BullMQ
  SENDING      // Sendo enviado
  SENT         // Enviado com sucesso
  DELIVERED    // Entregue (confirma√ß√£o do provedor)
  READ         // Lido pelo destinat√°rio
  FAILED       // Falhou
}

model Message {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  contactId       String
  contact         Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Origem da mensagem
  campaignId      String?
  campaign        Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  flowExecutionId String?
  flowExecution   FlowExecution? @relation(fields: [flowExecutionId], references: [id], onDelete: SetNull)

  // Conte√∫do
  channel         MessageChannel
  content         String        @db.Text
  mediaUrl        String?

  // Agendamento
  scheduledFor    DateTime?     // Null = enviar imediatamente

  // Status e tracking
  status          MessageStatus @default(PENDING)
  errorMessage    String?       @db.Text

  // Timestamps
  createdAt       DateTime      @default(now())
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  failedAt        DateTime?

  // ID externo do provedor (WhatsApp, SendGrid, etc)
  externalId      String?

  // Metadata adicional
  metadata        Json?

  @@index([organizationId, createdAt])
  @@index([contactId, createdAt])
  @@index([campaignId])
  @@index([flowExecutionId])
  @@index([status, scheduledFor])  // Para processar fila
  @@map("messages")
}

// Rela√ß√£o de mensagens em FlowExecution
model FlowExecution {
  // ... campos existentes ...
  messages Message[]
}

// =====================================================
// INTEGRA√á√ïES (APIs EXTERNAS)
// =====================================================

enum IntegrationType {
  WHATSAPP_BUSINESS  // WhatsApp Cloud API ou Evolution API
  INSTAGRAM          // Instagram Graph API
  FACEBOOK           // Facebook Graph API
  SENDGRID           // Email
  RESEND             // Email (alternativa)
  TWILIO             // SMS
  SHOPIFY            // E-commerce (futuro)
}

model Integration {
  id              String           @id @default(cuid())
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type            IntegrationType

  // Status
  isActive        Boolean          @default(true)
  isConnected     Boolean          @default(false)

  // Credenciais (ENCRIPTADAS!)
  credentials     Json             // { apiKey, apiSecret, token, etc }

  // Configura√ß√µes espec√≠ficas
  config          Json?            // Configura√ß√µes adicionais por tipo

  // Webhook (para receber updates)
  webhookUrl      String?
  webhookSecret   String?

  // Sincroniza√ß√£o
  lastSyncAt      DateTime?
  lastError       String?          @db.Text

  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([organizationId, type])  // Uma integra√ß√£o de cada tipo por org
  @@index([organizationId])
  @@map("integrations")
}

// =====================================================
// AUTOMA√á√ÉO DE ANIVERS√ÅRIOS
// =====================================================

model BirthdayAutomation {
  id              String           @id @default(cuid())
  organizationId  String           @unique
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Configura√ß√£o
  isEnabled       Boolean          @default(true)
  template        String           @db.Text  // "Feliz anivers√°rio {{nome}}! üéâ"
  channel         MessageChannel   @default(WHATSAPP)
  sendAtHour      Int              @default(9)  // Hora do dia (0-23)

  // Estat√≠sticas
  totalSent       Int              @default(0)
  lastSentAt      DateTime?

  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@map("birthday_automations")
}

// =====================================================
// AUDITORIA E LOGS
// =====================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id              String       @id @default(cuid())

  // Usu√°rio que executou
  userId          String?
  user            User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userName        String?      // Cache do nome (caso usu√°rio seja deletado)
  userRole        UserRole?

  // A√ß√£o
  action          AuditAction
  tableName       String       // Ex: "contacts", "flows"
  recordId        String?      // ID do registro afetado

  // Dados (antes/depois)
  oldData         Json?
  newData         Json?
  changedFields   String[]     // Campos que mudaram

  // Contexto
  ipAddress       String?
  userAgent       String?
  metadata        Json?

  // Timestamp
  createdAt       DateTime     @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([tableName, recordId])
  @@map("audit_logs")
}

// =====================================================
// FUN√á√ïES E TRIGGERS (PostgreSQL)
// =====================================================

// Trigger para atualizar updated_at automaticamente
// CREATE OR REPLACE FUNCTION update_updated_at_column()
// RETURNS TRIGGER AS $$
// BEGIN
//     NEW.updated_at = NOW();
//     RETURN NEW;
// END;
// $$ language 'plpgsql';

// Aplicar em todas as tabelas:
// CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
//     FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

// =====================================================
// √çNDICES COMPOSTOS ADICIONAIS (Performance)
// =====================================================

// Contact.birthdate index para query eficiente de aniversariantes:
// CREATE INDEX idx_contacts_birthday_month_day
//     ON contacts (EXTRACT(MONTH FROM birthdate), EXTRACT(DAY FROM birthdate));

// Message.scheduledFor para processar fila:
// CREATE INDEX idx_messages_queue
//     ON messages (status, scheduled_for)
//     WHERE status IN ('PENDING', 'QUEUED');

// =====================================================
// VIEWS √öTEIS (PostgreSQL)
// =====================================================

// View de estat√≠sticas por organiza√ß√£o
// CREATE VIEW organization_stats AS
// SELECT
//     o.id,
//     o.name,
//     COUNT(DISTINCT c.id) as total_contacts,
//     COUNT(DISTINCT f.id) as total_flows,
//     COUNT(DISTINCT m.id) as total_messages,
//     SUM(CASE WHEN m.created_at >= date_trunc('month', CURRENT_DATE) THEN 1 ELSE 0 END) as messages_this_month
// FROM organizations o
// LEFT JOIN contacts c ON c.organization_id = o.id
// LEFT JOIN flows f ON f.organization_id = o.id
// LEFT JOIN messages m ON m.organization_id = o.id
// GROUP BY o.id, o.name;

// =====================================================
// RESUMO DO SCHEMA
// =====================================================
//
// üìä Total de Tabelas: 12
//
// 1. users                 - Autentica√ß√£o e perfis
// 2. organizations         - Multi-tenancy (lojas/empresas)
// 3. contacts              - CRM de clientes
// 4. tags                  - Segmenta√ß√£o de contatos
// 5. kanban_columns        - Pipeline de vendas
// 6. flows                 - Automa√ß√µes (flow builder)
// 7. flow_executions       - Hist√≥rico de execu√ß√µes
// 8. campaigns             - Campanhas de mensagens/posts
// 9. messages              - Hist√≥rico de mensagens
// 10. integrations         - APIs externas
// 11. birthday_automations - Config de anivers√°rios
// 12. audit_logs           - Auditoria completa
//
// =====================================================
